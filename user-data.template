# cloud-config
## editors ## (emacs/sublime) -*- coding: utf8-nix; tab-width: 2; mode: yaml; indent-tabs-mode: nil; basic-offset: 2; st-word_wrap: 'true' -*- ## (jEdit) :tabSize=2:indentSize=2:mode=yaml: ## (notepad++) vim:tabstop=2:syntax=yaml:expandtab:smarttab:softtabstop=2 ## modeline (see <https://archive.is/djTUD>@@<http://webcitation.org/66W3EhCAP> ) -->
## spell-checker:ignore expandtab modeline smarttab softtabstop

## spell-checker:ignore NOPASSWD fdfind firstboot mydestination pipefail postconf relayhost runcmd rustdesk tailscaled
hostname: ug-debian-cloud-1
fqdn: ug-debian-cloud-1.local

manage_etc_hosts: true

users:
  - name: toor
    password: password
    groups: sudo
    shell: /bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    ssh_authorized_keys:
      # Your generator will replace this block with multiple keys:
      #   - ssh-ed25519 AAAA...
      #   - ssh-ed25519 BBBB...
      [ AUTHORIZED_SSH_PUBLIC_KEYS ]

package_update: true
package_upgrade: true

packages:
  - openssh-server
  - fail2ban
  - postfix
  - tailscale
  - kde-standard
  - sddm
  - rustdesk
  - ripgrep
  - fd-find
  - exa
  - lsd
  - fzf
  - zoxide
  - curl
  - git
  - build-essential
  - nodejs
  - npm

# Use write_files + a small script to keep things idempotent
write_files:
  - path: /usr/local/sbin/firstboot-setup.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      ADMIN_USER="toor"
      ADMIN_HOME="/home/${ADMIN_USER}"
      BASHRC="${ADMIN_HOME}/.bashrc"

      # Ensure admin home exists
      if ! id "${ADMIN_USER}" &>/dev/null; then
        echo "User ${ADMIN_USER} does not exist; exiting."
        exit 0
      fi

      # ---- fd convenience symlink ----
      if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then
        ln -sf "$(command -v fdfind)" /usr/local/bin/fd
      fi

      # ---- Ensure zoxide init lines present ----
      if command -v zoxide &>/dev/null; then
        ZOX_LINE='eval "$(zoxide init bash)"'
        if ! grep -Fxq "${ZOX_LINE}" "${BASHRC}" 2>/dev/null; then
          echo "${ZOX_LINE}" >> "${BASHRC}"
        fi
      fi

      # ---- Ensure fzf key-bindings/completion sourced (if present) ----
      if [ -f /usr/share/doc/fzf/examples/key-bindings.bash ]; then
        FZF_KB='source /usr/share/doc/fzf/examples/key-bindings.bash'
        if ! grep -Fxq "${FZF_KB}" "${BASHRC}" 2>/dev/null; then
          echo "${FZF_KB}" >> "${BASHRC}"
        fi
      fi

      if [ -f /usr/share/doc/fzf/examples/completion.bash ]; then
        FZF_COMP='source /usr/share/doc/fzf/examples/completion.bash'
        if ! grep -Fxq "${FZF_COMP}" "${BASHRC}" 2>/dev/null; then
          echo "${FZF_COMP}" >> "${BASHRC}"
        fi
      fi

      chown "${ADMIN_USER}:${ADMIN_USER}" "${BASHRC}"

      # ---- Postfix basic local-only config (idempotent via postconf) ----
      if command -v postconf &>/dev/null; then
        postconf -e "inet_interfaces = loopback-only"
        postconf -e "mydestination = localhost"
        # Set/clear relayhost explicitly instead of appending to main.cf
        postconf -e "relayhost ="
        systemctl restart postfix || true
      fi

      # ---- Services enabled (safe to re-run) ----
      systemctl enable sddm || true
      systemctl enable tailscaled || true
      systemctl restart tailscaled || true
      systemctl enable fail2ban || true
      systemctl restart fail2ban || true

      # ---- Codex AI CLI install/update ----
      if command -v npm &>/dev/null; then
        # Re-running is fine; npm will just update/confirm
        npm install -g @openai/codex || true
      fi

runcmd:
  # Ensure script is executable (already set in write_files, but harmless)
  - [ chmod, "+x", "/usr/local/sbin/firstboot-setup.sh" ]
  # Run idempotent setup script
  - [ /usr/local/sbin/firstboot-setup.sh ]

final_message: "Debian VM setup complete (idempotent firstboot script applied)."
